<div class="app-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo">
      <img src="logo.png" alt="TT" width="60%">
    </div>
    <nav>
      <ul>
        <li><a routerLink="/dashboard"><i class="fas fa-chart-line"></i> Tableau de bord</a></li>
        <li><a routerLink="/users" class="active"><i class="fas fa-users"></i> Utilisateurs</a></li>
        <li><a routerLink="/catalog"><i class="fas fa-shopping-cart"></i> Catalogue des offres</a></li>
        <li><a routerLink="/stock"><i class="fas fa-box"></i> Stock</a></li>
        <li class="logout"><a href="" (click)="logout()"><i class="fas fa-sign-out-alt"></i> Déconnexion</a></li>
      </ul>
    </nav>
  </div>

  <!-- Contenu principal -->
  <main class="main-content">
    <!-- En-tête -->
    <header class="top-header">
      <div class="row content-header">
        <div class="col-10">
          <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Rechercher un utilisateur..." [(ngModel)]="searchQuery" (input)="onSearch()">
          </div>
        </div>
        <div class="col-2 bloc-profile">
          <div class="user-menu">
              <img routerLink ="/profilA" [src]="user.avatarUrl" alt="Avatar"class="profile-image"  width="25%"/>  
        </div>
        </div>
      </div>

      
    </header>

    <!-- Contenu de la page -->
    <div class="content-container">
      <div class="page-header">
        <h1>Liste des utilisateurs</h1>
        <button class="btn primary" (click)="openAddUserModal()">
          <i class="fas fa-user-plus"></i> Ajouter un utilisateur
        </button>
      </div>

      <!-- Tableau des utilisateurs -->
      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>Identifiant</th>
              <th>Nom d'utilisateur</th>
              <th>E-mail</th>
              <th>Rôle</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of filteredUsers">
              <td>{{ user.identifiant }}</td>
              <td>{{ user.nomUtilisateur }}</td>
              <td>{{ user.email }}</td>
              <td>{{ getRole(user.idRole) }}</td>
            <td>
            <span [ngClass]="user.statut === 'Actif' ? 'statut-actif' : 'statut-inactif'">
             {{ user.statut }}
            </span>
            </td>
              <td>
                <button class="btn icon-btn" (click)="editUser(user)">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn icon-btn danger" (click)="deleteUser(user.id)">
                  <i class="fas fa-trash"></i>
                </button>
                
                <button class="btn icon-btn" [ngClass]="user.statut === 'Actif' ? 'block-btn' : 'unblock-btn'" (click)="blockUser(user.id)" >
                  <i class="fas" [ngClass]="user.statut === 'Actif' ? 'fa-ban' : 'fa-unlock'"></i>
                </button>
              </td>
            </tr>
            <tr *ngIf="filteredUsers.length === 0">
              <td colspan="6">Aucun utilisateur trouvé.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Modal utilisateur -->
  <div class="modal" *ngIf="showUserModal">
    <div class="modal-content">
      <h2>{{ editMode ? 'Modifier' : 'Ajouter' }} un utilisateur</h2>
      <form (ngSubmit)="onSubmitUserForm()">
       <!-- Champ identifiant avec la validation -->
<div class="info-group">
  <label>Identifiant</label>
  <input 
    type="text" 
    [(ngModel)]="currentUser.identifiant" 
    name="identifiant" 
    required 
    [readonly]="editMode"
    #identifiantInput="ngModel"
    [ngClass]="{ 'invalid': identifiantInput.invalid && identifiantInput.touched }"
    [pattern]="'^[a-zA-Z0-9]{10}$'" 
  />
  
  <!-- Alerte pour l'ajout si identifiant ne respecte pas les critères -->
  <div *ngIf="!editMode && identifiantInput.invalid && identifiantInput.touched" class="alert" color="red">
    L'identifiant doit contenir exactement 10 caractères et être composé uniquement de lettres et de chiffres.
  </div>
</div>

  
        <div class="info-group">
          <label>Nom d'utilisateur</label>
          <input type="text" [(ngModel)]="currentUser.nomUtilisateur" name="nomUtilisateur" required>
        </div>
  
<div class="info-group">
  <label>E-mail</label>
  <input 
    type="email" 
    [(ngModel)]="currentUser.email" 
    name="email" 
    required 
    #emailInput="ngModel"
    [ngClass]="{ 'invalid': emailInput.invalid && emailInput.touched }"
    [pattern]="'^[a-zA-Z0-9._%+-]+&#64;[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$'" />

 
  <div *ngIf="emailInput.invalid && emailInput.touched" class="alert">
    L'email doit être valide et contenir un '&#64;'
  </div>
</div>


  
        <div class="info-group">
          <label>Rôle</label>
          <select [(ngModel)]="currentUser.idRole" name="role" required>
            <option value="1">Admin</option>
            <option value="2">Agent Commercial</option>
            <option value="3">Agent Technique</option>
          </select>
        </div>
  
        <div class="info-group">
          <label>Statut</label>
          <select [(ngModel)]="currentUser.statut" name="statut" required>
            <option value="Actif">Actif</option>
            <option value="Inactif">Inactif</option>
          </select>
        </div>
  
        <div class="modal-buttons">
          <button type="submit" class="btn primary" [disabled]="identifiantInput.invalid && !editMode">
            {{ editMode ? 'Enregistrer' : 'Ajouter' }}
          </button>
          <button type="button" class="btn secondary" (click)="closeUserModal()">Annuler</button>
        </div>
      </form>
    </div>
  </div>
</div>